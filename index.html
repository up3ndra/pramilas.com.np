<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: padding-bottom 0.3s ease-in-out;
        }
        /* Custom styling for focus states to match the design */
        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); /* Indigo-500 with opacity */
            border-color: #6366f1; /* Indigo-500 */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            display: none;
            text-align: center;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        .add-expense-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--fallback-b2, oklch(var(--b2)));
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        .add-expense-drawer.open {
            transform: translateY(0);
        }
        .tabs-container {
            overflow-x: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .tabs-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }

        /* Changes for the more compact table */
        .table-compact th, .table-compact td {
            padding: 0.5rem 0.75rem; /* Reduced padding */
        }
        .table-compact tr td:first-child, .table-compact tr th:first-child {
            padding-left: 0.75rem;
        }
        .table-compact tr td:last-child, .table-compact tr th:last-child {
            padding-right: 0.75rem;
        }
    </style>
</head>
<body class="bg-base-200">

    <div class="container bg-base-100 shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-base-content">Daily Expenses Tracker</h1>
            <button id="theme-toggle-btn" class="btn btn-ghost btn-circle">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1m-16 0H3m15.364 4.364l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>
        
        <!-- Authentication UI - Content will be dynamically populated -->
        <div id="auth-ui" class="text-center mb-4"></div>

        <!-- Expense Tracker UI - hidden by default until user is authenticated -->
        <div id="tracker-ui" style="display: none;">
            <div id="nepali-date" class="text-center text-lg font-semibold text-indigo-600 mb-4"></div>

            <!-- Date Filtering Section -->
            <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-2 md:space-y-0">
                <div class="flex items-center space-x-2">
                    <label for="display-year-select" class="text-gray-600 font-medium">Filter by:</label>
                    <select id="display-year-select" class="select select-bordered select-sm w-32"></select>
                    <!-- Month Dropdown (Mobile) -->
                  <div class="w-full md:hidden">
                    <select id="month-dropdown" class="select select-bordered select-sm w-full">
                        <!-- Month options will be populated here -->
                    </select>
                  </div>
                </div>
                
                <!-- Month Tabs (Desktop) -->
                <div id="month-tabs" class="tabs tabs-boxed tabs-container flex-nowrap hidden md:flex">
                    <!-- Month tabs will be populated here -->
                </div>
                
                
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-2 md:space-y-0">
                <div id="total-amount" class="text-2xl font-bold text-base-content"></div>
                <div class="flex space-x-4">
                    <button id="export-csv-btn" class="flex items-center space-x-1 text-sm text-gray-600 hover:text-blue-500 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span>Export as CSV</span>
                    </button>
                    <button id="export-all-btn" class="flex items-center space-x-1 text-sm text-gray-600 hover:text-blue-500 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span>Export All Data</span>
                    </button>
                    <button id="clear-btn" class="flex items-center space-x-1 text-sm text-gray-600 hover:text-red-500 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                        <span>Clear All Data</span>
                    </button>
                </div>
            </div>

            <!-- Expenses Table -->
            <div class="overflow-x-auto bg-base-100 rounded-lg shadow-md">
                <table class="table table-compact w-full">
                    <thead>
                        <tr>
                            <th class="text-left">Date</th>
                            <th class="text-left">Amount</th>
                            <th class="text-left">Remarks</th>
                            <th class="text-left">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body">
                        <!-- Expense rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Expense Form - Fixed at the bottom -->
    <div id="add-expense-toggle-btn-container" class="fixed bottom-0 left-0 w-full p-4 md:hidden">
      <button id="toggle-add-expense-btn" class="btn btn-primary w-full shadow-lg">Add New Expense</button>
    </div>

    <div id="add-expense-drawer" class="add-expense-drawer p-6">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-xl font-semibold text-base-content mb-4 flex justify-between items-center">
                <span>Add New Expense</span>
                <button id="close-add-expense-btn" class="btn btn-sm btn-circle btn-ghost">âœ•</button>
            </h2>
            <div class="flex flex-wrap items-end gap-2">
                <select id="date-month-select" class="select select-bordered select-sm w-full md:w-auto"></select>
                <select id="date-day-select" class="select select-bordered select-sm w-full md:w-auto"></select>
                <select id="date-year-select" class="select select-bordered select-sm w-full md:w-auto"></select>
                <input id="amount" type="number" class="input input-bordered input-sm w-full md:flex-1" placeholder="Amount (in Rs. )">
                <input id="remarks" type="text" class="input input-bordered input-sm w-full md:flex-1" placeholder="Remarks (e.g., Groceries)">
                <button id="add-btn" class="btn btn-primary btn-sm w-full md:w-auto">
                    Add Expense
                </button>
                <label for="import-csv-file" class="btn btn-sm btn-secondary w-full md:w-auto cursor-pointer">
                    Import from CSV
                </label>
                <input id="import-csv-file" type="file" accept=".csv" class="hidden">
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="overlay" class="overlay"></div>
    <div id="message-box" class="message-box">
        <p id="message-text" class="text-gray-800 text-lg mb-4"></p>
        <div id="message-buttons" class="flex justify-center space-x-4">
            <!-- Buttons will be added dynamically -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, collection, query, onSnapshot, getDocs, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Enable debug logging for Firebase
        setLogLevel('debug');

        // Your Firebase project settings, provided directly to the app
        const firebaseConfig = {
            apiKey: "AIzaSyAVEmsWiXCOXUo4TfvnaSQAoA6O2sXLxA4",
            authDomain: "expense-tracker-55c75.firebaseapp.com",
            projectId: "expense-tracker-55c75",
            storageBucket: "expense-tracker-55c75.firebasestorage.app",
            messagingSenderId: "328259717439",
            appId: "1:328259717439:web:daa8bcac406a8e8ec3ab8a",
            measurementId: "G-YRWL6JH8HL"
        };
        
        // Map of Nepali month names to a numerical order for sorting and display
        const monthOrder = {
            'baisakh': 1, 'jestha': 2, 'ashadh': 3, 'shrawan': 4, 'bhadra': 5,
            'ashwin': 6, 'kartik': 7, 'mangsir': 8, 'poush': 9, 'magh': 10,
            'falgun': 11, 'chaitra': 12
        };

        // Simplified Nepali date conversion logic (for demonstration purposes only)
        // This is a basic conversion for a specific year range and may not be 100% accurate for all dates.
        const nepaliMonths = ['Baisakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin', 'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'];
        const BS_OFFSET_YEAR = 2081;
        const BS_OFFSET_MONTH = 6;
        const BS_OFFSET_DAY = 18;

        function getNepaliDate(date) {
            // Simplified logic based on a known offset
            const englishYear = date.getFullYear();
            const englishMonth = date.getMonth();
            const englishDay = date.getDate();

            const yearDiff = englishYear - 2024;
            let bsYear = BS_OFFSET_YEAR + yearDiff;
            let bsMonth = BS_OFFSET_MONTH;
            let bsDay = BS_OFFSET_DAY;

            // This is a very basic approximation.
            // A real-world application would use a precise algorithm or library.
            if (englishMonth > 5 || (englishMonth === 5 && englishDay >= 18)) {
                bsYear += 1;
            }
            
            // For a more accurate conversion, a complex calendar conversion table would be needed.
            // Let's just hardcode a fixed date for now to show the feature.
            const currentDate = new Date();
            const year = 2082; // Example for a known date
            const month = nepaliMonths[5]; // Ashwin
            const day = 3; // Example day
            return `${month} ${day}, ${year}`;
        }

        let db;
        let auth;
        let userId = null;
        let expenses = []; // Cache all expenses to make filtering easy
        let selectedYear = 'all'; // Default to "all years"
        let selectedMonth = 'all'; // Default to "all months"
        
        // Declare a variable to hold the unsubscribe function for the Firestore listener
        let unsubscribeExpensesListener = null;

        const expensesCollectionPath = `/artifacts/${firebaseConfig.projectId}/users/`;
        const trackerUi = document.getElementById('tracker-ui');
        const addExpenseDrawer = document.getElementById('add-expense-drawer');
        const container = document.querySelector('.container');

        document.addEventListener('DOMContentLoaded', () => {
            const dateMonthSelect = document.getElementById('date-month-select');
            const dateDaySelect = document.getElementById('date-day-select');
            const dateYearSelect = document.getElementById('date-year-select');
            const amountInput = document.getElementById('amount');
            const remarksInput = document.getElementById('remarks');
            const addBtn = document.getElementById('add-btn');
            const clearBtn = document.getElementById('clear-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportAllBtn = document.getElementById('export-all-btn');
            const importCsvFile = document.getElementById('import-csv-file');
            const expenseTableBody = document.getElementById('expense-table-body');
            const totalAmountDiv = document.getElementById('total-amount');
            const messageBox = document.getElementById('message-box');
            const overlay = document.getElementById('overlay');
            const messageText = document.getElementById('message-text');
            const messageButtons = document.getElementById('message-buttons');
            const authUiDiv = document.getElementById('auth-ui');
            const displayYearSelect = document.getElementById('display-year-select');
            const monthTabs = document.getElementById('month-tabs');
            const monthDropdown = document.getElementById('month-dropdown');
            const nepaliDateDiv = document.getElementById('nepali-date');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const toggleAddExpenseBtn = document.getElementById('toggle-add-expense-btn');
            const closeAddExpenseBtn = document.getElementById('close-add-expense-btn');
            const addExpenseToggleBtnContainer = document.getElementById('add-expense-toggle-btn-container');
            const addExpenseFormContainer = document.getElementById('add-expense-drawer');

            // --- Theme Toggling Logic ---
            function setInitialTheme() {
                const preferredTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', preferredTheme);
                if (preferredTheme === 'dark') {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            setInitialTheme();

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                if (newTheme === 'dark') {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            });

            // --- UI Setup Functions ---
            function showMessageBox(message, buttons) {
                messageText.textContent = message;
                messageButtons.innerHTML = '';
                buttons.forEach(btn => {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = btn.text;
                    buttonElement.className = `btn btn-sm ${btn.class}`;
                    buttonElement.onclick = () => {
                        closeMessageBox();
                        if (btn.callback) {
                            btn.callback();
                        }
                    };
                    messageButtons.appendChild(buttonElement);
                });
                messageBox.style.display = 'block';
                overlay.style.display = 'block';
            }

            function closeMessageBox() {
                messageBox.style.display = 'none';
                overlay.style.display = 'none';
            }
            
            function renderAuthUI(user) {
                authUiDiv.innerHTML = '';
                if (user) {
                    // Authenticated user: Show sign-out button
                    authUiDiv.innerHTML = `
                        <div class="flex items-center justify-end space-x-2">
                            <span class="text-sm text-gray-500">Signed in as: ${user.displayName || user.email || 'User'}</span>
                            <button id="signout-btn" class="btn btn-sm btn-outline btn-error">Sign Out</button>
                        </div>
                    `;
                    document.getElementById('signout-btn').addEventListener('click', signOutUser);
                } else {
                    // No user: Show login/signup form
                    authUiDiv.innerHTML = `
                        <div class="bg-base-100 rounded-lg p-6 max-w-sm mx-auto shadow-md">
                            <h3 class="font-bold text-lg mb-4">Sign In to Your Account</h3>
                            <input id="username-input" type="email" placeholder="Email" class="input input-bordered input-sm mb-2 w-full">
                            <input id="password-input" type="password" placeholder="Password" class="input input-bordered input-sm mb-4 w-full">
                            <div class="flex flex-col space-y-2">
                                <button id="signin-btn" class="btn btn-sm btn-outline btn-primary">Sign In</button>
                                <button id="signup-btn" class="btn btn-sm btn-outline btn-secondary">Sign Up</button>
                            </div>
                        </div>
                    `;
                    // Re-attach event listeners after the new HTML is injected
                    document.getElementById('signin-btn').addEventListener('click', signInWithUsername);
                    document.getElementById('signup-btn').addEventListener('click', signUpWithUsername);
                }
            }

            function renderMonthTabs() {
                monthTabs.innerHTML = '';
                const months = ['all', ...Object.keys(monthOrder)];
                months.forEach(month => {
                    const a = document.createElement('a');
                    a.textContent = month === 'all' ? 'All' : month.charAt(0).toUpperCase() + month.slice(1);
                    a.classList.add('tab', 'whitespace-nowrap');
                    if (month === 'all') {
                        a.classList.add('text-xs'); // Make "All" even more compact
                    }
                    a.dataset.month = month;
                    if (month === selectedMonth) {
                        a.classList.add('tab-active');
                    }
                    a.addEventListener('click', () => {
                        selectedMonth = month;
                        document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('tab-active'));
                        a.classList.add('tab-active');
                        filterAndRenderExpenses();
                    });
                    monthTabs.appendChild(a);
                });
            }

            function renderMonthDropdown() {
                monthDropdown.innerHTML = '';
                const months = ['all', ...Object.keys(monthOrder)];
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month === 'all' ? 'All Months' : month.charAt(0).toUpperCase() + month.slice(1);
                    if (month === selectedMonth) {
                        option.selected = true;
                    }
                    monthDropdown.appendChild(option);
                });
                
                monthDropdown.addEventListener('change', (e) => {
                    selectedMonth = e.target.value;
                    filterAndRenderExpenses();
                });
            }


            function renderYearDropdown() {
                const startYear = 2080;
                const endYear = 2090;
                displayYearSelect.innerHTML = '';
                
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Years';
                displayYearSelect.appendChild(allOption);

                for (let year = startYear; year <= endYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (String(year) === String(selectedYear)) {
                        option.selected = true;
                    }
                    displayYearSelect.appendChild(option);
                }
                displayYearSelect.value = selectedYear; // Ensure the correct option is selected

                displayYearSelect.addEventListener('change', (e) => {
                    selectedYear = e.target.value;
                    filterAndRenderExpenses();
                });
            }

            function populateDateDropdowns() {
                // Populate Month dropdown
                dateMonthSelect.innerHTML = '<option value="">Select Month</option>';
                Object.keys(monthOrder).forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                    dateMonthSelect.appendChild(option);
                });

                // Populate Year dropdown
                dateYearSelect.innerHTML = '<option value="">Select Year</option>';
                const startYear = 2080;
                const endYear = 2090;
                for (let year = startYear; year <= endYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    dateYearSelect.appendChild(option);
                }

                // Populate Day dropdown
                const populateDays = (month, year) => {
                    dateDaySelect.innerHTML = '<option value="">Select Day</option>';
                    // This is a simplified approach, a real app would use precise day counts
                    const daysInMonth = 32; 
                    for (let day = 1; day <= daysInMonth; day++) {
                        const option = document.createElement('option');
                        option.value = day;
                        option.textContent = day;
                        dateDaySelect.appendChild(option);
                    }
                };

                dateMonthSelect.addEventListener('change', () => populateDays(dateMonthSelect.value, dateYearSelect.value));
                dateYearSelect.addEventListener('change', () => populateDays(dateMonthSelect.value, dateYearSelect.value));
                populateDays(); // Initial population
            }
            
            // --- Core Logic Functions ---
            function filterAndRenderExpenses() {
                // Filter expenses based on the selected year and month
                const filteredExpenses = expenses.filter(expense => {
                    try {
                        const [month, day, year] = expense.date.toLowerCase().split(/[,\s]+/);
                        const yearMatch = selectedYear === 'all' || parseInt(year, 10) === parseInt(selectedYear, 10);
                        const monthMatch = selectedMonth === 'all' || month === selectedMonth;
                        return yearMatch && monthMatch;
                    } catch (e) {
                        console.warn('Invalid date format in expense, skipping:', expense.date);
                        return false;
                    }
                });
            
                // Sort the filtered expenses
                filteredExpenses.sort((a, b) => {
                    const parseNepaliDate = (dateStr) => {
                        const parts = dateStr.toLowerCase().split(/[,\s]+/);
                        const month = parts[0];
                        const day = parseInt(parts[1], 10);
                        const year = parseInt(parts[2], 10);
                        return { year, monthIndex: monthOrder[month], day };
                    };
                    const dateA = parseNepaliDate(a.date);
                    const dateB = parseNepaliDate(b.date);
            
                    if (dateA.year !== dateB.year) return dateA.year - dateB.year;
                    if (dateA.monthIndex !== dateB.monthIndex) return dateA.monthIndex - dateB.monthIndex;
                    return dateA.day - dateB.day;
                });
            
                renderExpenses(filteredExpenses);
            }

            function renderExpenses(expensesToRender) {
                expenseTableBody.innerHTML = '';
                let total = 0;

                if (expensesToRender.length === 0) {
                    expenseTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No expenses recorded for this selection.</td></tr>`;
                    totalAmountDiv.textContent = 'Total: Rs. 0.00';
                    return;
                }

                expensesToRender.forEach((expense) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${expense.date}</td>
                        <td>Rs. ${parseFloat(expense.amount).toFixed(2)}</td>
                        <td>${expense.remarks}</td>
                        <td>
                            <button data-id="${expense.id}" class="delete-btn btn btn-xs btn-error">Delete</button>
                        </td>
                    `;
                    expenseTableBody.appendChild(row);
                    total += parseFloat(expense.amount);
                });
                
                totalAmountDiv.textContent = `Total: Rs. ${total.toFixed(2)}`;

                // Add event listeners to newly created delete buttons
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.target.getAttribute('data-id');
                        showMessageBox(
                            "Are you sure you want to delete this expense? This action cannot be undone.",
                            [
                                { text: "Cancel", class: "btn-outline btn-info", callback: null },
                                { text: "Confirm", class: "btn-error", callback: () => deleteExpense(id) }
                            ]
                        );
                    });
                });
            }

            // Function to add a new expense
            async function addExpense() {
                const month = dateMonthSelect.value;
                const day = dateDaySelect.value;
                const year = dateYearSelect.value;
                const amount = amountInput.value;
                const remarks = remarksInput.value;

                if (!month || !day || !year || !amount || !remarks) {
                    showMessageBox(
                        'Please fill out all fields.', 
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                    return;
                }

                if (parseFloat(amount) <= 0) {
                    showMessageBox(
                        'Amount must be a positive number.',
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                    return;
                }

                const date = `${month.charAt(0).toUpperCase() + month.slice(1)} ${day}, ${year}`;

                try {
                    await addDoc(collection(db, `${expensesCollectionPath}${userId}/expenses`), { date, amount, remarks });
                    // Clear input fields after successful addition
                    // Set dropdowns back to current date
                    const todayNepaliDate = getNepaliDate(new Date());
                    const [currentMonthName, currentDay, currentYear] = todayNepaliDate.toLowerCase().split(/[,\s]+/);
                    dateMonthSelect.value = currentMonthName;
                    dateDaySelect.value = currentDay;
                    dateYearSelect.value = currentYear;
                    amountInput.value = '';
                    remarksInput.value = '';
                    addExpenseDrawer.classList.remove('open');
                    container.classList.remove('pb-48');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessageBox(
                        "Error adding expense. Please try again.",
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                }
            }

            // Function to delete an expense
            async function deleteExpense(id) {
                try {
                    await deleteDoc(doc(db, `${expensesCollectionPath}${userId}/expenses`, id));
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessageBox(
                        "Error deleting expense. Please try again.",
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                }
            }

            // Function to clear all data
            async function clearAllData() {
                showMessageBox(
                    'Are you sure you want to delete all data? All expenses will be permanently removed.',
                    [
                        { text: "Cancel", class: "btn-outline btn-info", callback: null },
                        { text: "Confirm", class: "btn-error", callback: async () => {
                            const batch = writeBatch(db);
                            try {
                                const expensesRef = collection(db, `${expensesCollectionPath}${userId}/expenses`);
                                const q = query(expensesRef);
                                const querySnapshot = await getDocs(q);
                                querySnapshot.forEach((doc) => {
                                    batch.delete(doc.ref);
                                });
                                await batch.commit();
                                showMessageBox(
                                    "All data has been cleared.",
                                    [{ text: "OK", class: "btn-primary", callback: null }]
                                );
                            } catch (e) {
                                console.error("Error clearing data: ", e);
                                showMessageBox(
                                    "Error clearing data. Please try again.",
                                    [{ text: "OK", class: "btn-primary", callback: null }]
                                );
                            }
                        }}
                    ]
                );
            }
            
            // Function to handle exporting filtered data to CSV
            function exportToCsv() {
                const expensesToExport = selectedYear === 'all' && selectedMonth === 'all'
                    ? expenses
                    : expenses.filter(expense => {
                        try {
                            const [month, day, year] = expense.date.toLowerCase().split(/[,\s]+/);
                            const yearMatch = selectedYear === 'all' || parseInt(year, 10) === parseInt(selectedYear, 10);
                            const monthMatch = selectedMonth === 'all' || month === selectedMonth;
                            return yearMatch && monthMatch;
                        } catch (e) {
                            return false;
                        }
                    });

                if (expensesToExport.length === 0) {
                    showMessageBox(
                        "No expenses to export for the selected filter.",
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                    return;
                }

                const headers = ["Date", "Amount", "Remarks"];
                const csvRows = [
                    headers.join(','),
                    ...expensesToExport.map(expense => 
                        `${expense.date},${expense.amount},"${expense.remarks.replace(/"/g, '""')}"`
                    )
                ];
                const csvString = csvRows.join('\n');
                
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                
                let filename = 'all_expenses.csv';
                if (selectedYear !== 'all' && selectedMonth !== 'all') {
                    filename = `expenses_${selectedMonth}_${selectedYear}.csv`;
                } else if (selectedYear !== 'all') {
                    filename = `expenses_${selectedYear}.csv`;
                } else if (selectedMonth !== 'all') {
                    filename = `expenses_${selectedMonth}.csv`;
                }
                link.setAttribute("download", filename);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageBox(
                    "Filtered expenses exported successfully!",
                    [{ text: "OK", class: "btn-primary", callback: null }]
                );
            }
            
            // New function to handle exporting all data to CSV
            function exportAllDataToCsv() {
                if (expenses.length === 0) {
                    showMessageBox(
                        "No expenses to export.",
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                    return;
                }
                
                const headers = ["Date", "Amount", "Remarks"];
                const csvRows = [
                    headers.join(','),
                    ...expenses.map(expense => 
                        `${expense.date},${expense.amount},"${expense.remarks.replace(/"/g, '""')}"`
                    )
                ];
                const csvString = csvRows.join('\n');
                
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "all_expenses.csv");
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageBox(
                    "All expenses exported successfully!",
                    [{ text: "OK", class: "btn-primary", callback: null }]
                );
            }

            // Function to handle importing data from CSV
            function importFromCsv(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1); // Skip header row
                    
                    if (rows.length === 0) {
                        showMessageBox(
                            "The CSV file is empty or formatted incorrectly.",
                            [{ text: "OK", class: "btn-primary", callback: null }]
                        );
                        return;
                    }

                    const headers = text.split('\n')[0].split(',').map(h => h.trim().toLowerCase());
                    const dateIndex = headers.findIndex(h => h.includes('date') || h.includes('day'));
                    const amountIndex = headers.findIndex(h => h.includes('amount'));
                    const remarksIndex = headers.findIndex(h => h.includes('remarks'));

                    if (dateIndex === -1 || amountIndex === -1 || remarksIndex === -1) {
                        showMessageBox(
                            "CSV headers must contain 'date' (or 'day'), 'amount', and 'remarks'.",
                            [{ text: "OK", class: "btn-primary", callback: null }]
                        );
                        return;
                    }
                    
                    if (headers[dateIndex] === 'day' && (selectedMonth === 'all' || selectedYear === 'all')) {
                        showMessageBox(
                            "To import a CSV with a 'day' header, please first select a specific month and year using the filters at the top of the page.",
                            [{ text: "OK", class: "btn-primary", callback: null }]
                        );
                        return;
                    }
                    
                    const batch = writeBatch(db);
                    const expensesRef = collection(db, `${expensesCollectionPath}${userId}/expenses`);
                    
                    rows.forEach(row => {
                        const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
                        
                        const dateData = columns[dateIndex];
                        const amount = columns[amountIndex].replace(/,/g, '');
                        const remarks = columns[amountIndex];
                        let finalDate = dateData;

                        // Check if the header is 'day' and construct the full date
                        if (headers[dateIndex] === 'day') {
                            const formattedMonth = selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1);
                            finalDate = `${formattedMonth} ${dateData}, ${selectedYear}`;
                        }


                        // Check if the date is a valid format and the row is not empty
                        if (finalDate && amount && remarks) {
                            batch.set(doc(expensesRef), { date: finalDate, amount: parseFloat(amount), remarks });
                        }
                    });
                    
                    try {
                        await batch.commit();
                        showMessageBox(
                            "Expenses imported successfully!",
                            [{ text: "OK", class: "btn-primary", callback: null }]
                        );
                    } catch (e) {
                        console.error("Error importing documents: ", e);
                        showMessageBox(
                            "Error importing data. Check the CSV format and try again.",
                            [{ text: "OK", class: "btn-primary", callback: null }]
                        );
                    }
                };
                reader.readAsText(file);
            }
            
            async function signInWithUsername() {
                const username = document.getElementById('username-input').value;
                const password = document.getElementById('password-input').value;
                if (!username || !password) {
                    showMessageBox("Please enter both username and password.", [{ text: "OK", class: "btn-primary", callback: null }]);
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, username, password);
                } catch (error) {
                    console.error("Sign-in Error: ", error);
                    let errorMessage = "Sign-in failed. Please check your username and password.";
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid username format. Your username must be a valid email.';
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid username or password.';
                    }
                    showMessageBox(errorMessage, [{ text: "OK", class: "btn-primary", callback: null }]);
                }
            }

            async function signUpWithUsername() {
                const username = document.getElementById('username-input').value;
                const password = document.getElementById('password-input').value;
                if (!username || !password) {
                    showMessageBox("Please enter both username and password.", [{ text: "OK", class: "btn-primary", callback: null }]);
                    return;
                }
                try {
                    const result = await createUserWithEmailAndPassword(auth, username, password);
                    const user = result.user;
                    console.log("User signed up:", user);
                    showMessageBox("Sign up successful!", [{ text: "OK", class: "btn-primary", callback: null }]);
                } catch (error) {
                    console.error("Sign-up Error: ", error);
                    let errorMessage = "Sign-up failed. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'The username is already in use by another account.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password should be at least 6 characters.';
                    } else {
                        // A more generic message for other unknown errors
                        errorMessage = 'Sign-up failed. Please check your username and password.';
                    }
                    showMessageBox(errorMessage, [{ text: "OK", class: "btn-primary", callback: null }]);
                }
            }
            
            async function signOutUser() {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Sign-out Error: ", error);
                    showMessageBox(
                        "Sign-out failed. Please try again.",
                        [{ text: "OK", class: "btn-primary", callback: null }]
                    );
                }
            }

            // --- Initialization ---
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                populateDateDropdowns();
                renderYearDropdown();
                renderMonthTabs();
                renderMonthDropdown();

                // Get current Nepali date and use it to set initial filters
                const todayNepaliDate = getNepaliDate(new Date());
                const [currentMonthName, currentDay, currentYear] = todayNepaliDate.toLowerCase().split(/[,\s]+/);
                
                selectedYear = currentYear;
                selectedMonth = currentMonthName;
                
                // Display current Nepali date and pre-populate date dropdowns
                nepaliDateDiv.textContent = `Today is: ${todayNepaliDate}`;
                dateMonthSelect.value = currentMonthName;
                dateDaySelect.value = currentDay;
                dateYearSelect.value = currentYear;
                monthDropdown.value = currentMonthName;

                // Toggle add expense drawer logic
                toggleAddExpenseBtn.addEventListener('click', () => {
                    addExpenseDrawer.classList.add('open');
                    container.classList.add('pb-48');
                });
                closeAddExpenseBtn.addEventListener('click', () => {
                    addExpenseDrawer.classList.remove('open');
                    container.classList.remove('pb-48');
                });

                // This is the core logic that controls the UI flow based on authentication state
                onAuthStateChanged(auth, (user) => {
                    renderAuthUI(user);
                    if (user) {
                        // A user is signed in
                        userId = user.uid;
                        trackerUi.style.display = 'block';
                        addExpenseToggleBtnContainer.style.display = 'block';
                        
                        // Set up real-time listener for expenses
                        const q = query(collection(db, `${expensesCollectionPath}${userId}/expenses`));
                        
                        // Assign the unsubscribe function to the variable
                        unsubscribeExpensesListener = onSnapshot(q, (snapshot) => {
                            expenses = [];
                            snapshot.forEach((doc) => {
                                expenses.push({ id: doc.id, ...doc.data() });
                            });
                            
                            // Call the filter and render function to update the UI
                            filterAndRenderExpenses();
                        }, (error) => {
                            console.error("Error fetching expenses: ", error);
                            // Only show the message if the user is still logged in
                            // This prevents the error message on logout
                            if (auth.currentUser) {
                                showMessageBox(
                                    "Error loading expenses. Please refresh.",
                                    [{ text: "OK", class: "btn-primary", callback: null }]
                                );
                            }
                        });

                        // Attach event listeners for data operations ONLY when authenticated
                        addBtn.addEventListener('click', addExpense);
                        clearBtn.addEventListener('click', clearAllData);
                        exportCsvBtn.addEventListener('click', exportToCsv);
                        exportAllBtn.addEventListener('click', exportAllDataToCsv);
                        importCsvFile.addEventListener('change', importFromCsv);

                    } else {
                        // No user is signed in
                        userId = null;
                        trackerUi.style.display = 'none';
                        addExpenseToggleBtnContainer.style.display = 'none';
                        addExpenseDrawer.classList.remove('open');
                        container.classList.remove('pb-48');

                        // THIS IS THE FIX: Unsubscribe from the previous listener
                        if (unsubscribeExpensesListener) {
                            unsubscribeExpensesListener();
                            unsubscribeExpensesListener = null;
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase: ", e);
                showMessageBox(
                    "App initialization failed. Check console for details.",
                    [{ text: "OK", class: "btn-primary", callback: null }]
                );
            }
        });
    </script>
</body>
</html>
